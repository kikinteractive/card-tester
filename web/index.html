<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<meta name="description" content="">
	<meta name="author" content="">
	<link rel="shortcut icon" href="../../assets/ico/favicon.png">
	<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400,600">

	<title>Card Testing Service</title>

	<link href="css/bootstrap.css" rel="stylesheet">
	<link href="css/kikcup.css" rel="stylesheet">

	<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!--[if lt IE 9]>
	  <script src="../../assets/js/html5shiv.js"></script>
	  <script src="../../assets/js/respond.min.js"></script>
	  <![endif]-->

<style type="text/css">
	.screenshotcontainer {
		text-align: center;
	}
</style>

	</head>

	<body>
		<div class="navbar navbar-inverse navbar-fixed-top">
			<div class="container">
				<div class="navbar-header">
					<a class="navbar-brand" href="/"><span class="glyphicon glyphicon-cloud"></span> Card Testing Service</a>
				</div>
			</div>
		</div>

		<div class="container well">
			<div class="row">
				<div class="col-md-4">
					<h1>Card Testing Service</h1>
					<p>This server automates some of the repetitive tasks that must be checked before a card can be included in the More Card.</p>
				</div>
				<div class="col-md-8">
					<br/><br/>
					<form role="form">
						<div class="form-group m1n">
							<label for="cardurl">Card URL</label>
							<input type="text" class="form-control" id="cardurl" placeholder="Enter Card URL">
						</div>
						<div class="alertwrap">
							<div class="alert alert-danger hidden">
								<span></span>
							</div>
						</div>
						<div class="">
							<button id="submitbtn" type="submit" class="btn btn-success btn-lg">Run Tests</button>
						</div>
					</form>
					<br/>
				</div>
			</div>
		</div>

		<div class="container testresults hidden">
			<div class="row">
				<div class="col-md-12">
					<h3>Basic Tests</h3>
					<table class="table table-bordered moretests">
						<thead>
							<tr>
								<th>Test #</th>
								<th>Test</th>
								<th>Result</th>
								<th>Success</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<h3>Load & Speed Tests</h3>
					<table class="table table-bordered loadtests">
						<thead>
							<tr>
								<th>Test #</th>
								<th>Test</th>
								<th>Result</th>
								<th>Success</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<h3>Requests</h3>
					<table class="table table-bordered requests">
						<thead>
							<tr>
								<th>Request #</th>
								<th>URL</th>
								<th>Size</th>
								<th>DOMLoaded</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<h4 class="screenshotcontainer">Right after DOM Load</h4>
					<div class="screenshotcontainer screenshotcontainer1"></div>
				</div>
				<div class="col-md-6">
					<h4 class="screenshotcontainer">2 seconds after DOM Load</h4>
					<div class="screenshotcontainer screenshotcontainer2"></div>
				</div>
			</div>
		</div>

		<div class="container">
			<div class="row">
				<div class="col-md-12">
					<div class="tempp"></div>
				</div>
			</div>
		</div>

		<script src="//code.jquery.com/jquery.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="/zerver/API.js"></script>
		<script type="text/javascript">
			$("form").submit(function(d){

				var data = $("#cardurl").val();
				
				$(".alert").remove();

				if ( data.indexOf("http") != 0 ) {

					showFormError("URL must start with http or https");
					return false;
				}

				localStorage["lastURL"] = data;

				$("#submitbtn").addClass("disabled").text("Testing...");

				API.testCard(data, function(data){

					$("#submitbtn").removeClass("disabled").text("Run Tests");
					
					if ( !data ) {
						showFormError("Something went wrong :( Please try again.");
						return;
					}

					$(".testresults").removeClass("hidden");
					$(".moretests, .loadtests, .requests").find("tbody").html("");
					$(".screenshot").remove();

					var count = 0;

					if ( data.more && data.more.title ) {
						$(".moretests").find("tbody").append(getTableRow(++count, "Sidebar Title", data.more.title, true));
					} else {
						$(".moretests").find("tbody").append(getTableRow(++count, "Sidebar Title", "", false));
					}

					if ( data.more && data.more.icon ) {
						$(".moretests").find("tbody").append(getTableRow(++count, "Sidebar Icon", "<img style='width: 80px; height: 50px' src='" + data.more.icon + "' />", true));
					} else {
						$(".moretests").find("tbody").append(getTableRow(++count, "Sidebar Icon", "N/A", false));
					}

					if ( data.more && data.more.description ) {
						$(".moretests").find("tbody").append(getTableRow(++count, "More Description", data.more.description, true));
					} else {
						$(".moretests").find("tbody").append(getTableRow(++count, "More Description", "No description found", false));
					}

					if ( data.more && data.more.hostname ) {
						$(".moretests").find("tbody").append(getTableRow(++count, "Include In More", data.more.hostname, true));
					} else {
						$(".moretests").find("tbody").append(getTableRow(++count, "Include In More", "No kik-more tag found", false));
					}

					if ( data.unsupported ) {
						$(".moretests").find("tbody").append(getTableRow(++count, "Unsupported OS", data.unsupported, true));
					} else {
						$(".moretests").find("tbody").append(getTableRow(++count, "Unsupported OS", "N/A", true));
					}

					if ( data.link && data.link.terms ) {
						$(".moretests").find("tbody").append(getTableRow(++count, "T&C Provided", "<a href='" + data.link.terms + "'>" + data.link.terms + "</a>", true));
					} else {
						$(".moretests").find("tbody").append(getTableRow(++count, "T&C Provided", "Not Provided", true));
					}

					if ( data.link && data.link.privacy ) {
						$(".moretests").find("tbody").append(getTableRow(++count, "Privacy Policy Provided", "<a href='" + data.link.privacy + "'>" + data.link.privacy + "</a>", true));
					} else {
						$(".moretests").find("tbody").append(getTableRow(++count, "Privacy Policy Provided", "Not Provided", true));
					}

					count = 0;

					if ( data.load ) {
						$(".loadtests").find("tbody").append(getTableRow(++count, "Cache Manifest", data.load.manifest ? data.load.manifest : "No manifest found", data.load.manifest ? true : false));
					}

					if ( data.load && data.load.domLoad ) {
						$(".loadtests").find("tbody").append(getTableRow(++count, "DOMContentLoaded", data.load.domLoad + " ms", (data.load.domLoad < 1250 ? true : false)));
					}

					if ( data.load && data.load.fullLoad ) {
						$(".loadtests").find("tbody").append(getTableRow(++count, "Full Load Time", data.load.fullLoad + " ms", (data.load.fullLoad < 1250 ? true : false)));
					}

					if ( data.load && data.load.requestCount ) {
						$(".loadtests").find("tbody").append(getTableRow(++count, "# of Requests", data.load.requestCount, (data.load.requestCount < 50 ? true : false)));
					}

					if ( data.load && data.load.cardSize ) {
						$(".loadtests").find("tbody").append(getTableRow(++count, "Card Size", (data.load.cardSize/1000) + " kb", (data.load.cardSize < 350000 ? true : false)));
					}

					if ( data.screenshot ) {
						$(".screenshotcontainer1").append("<img class='screenshot img-thumbnail' src='" + data.screenshot + "' />");
						$(".screenshotcontainer2").append("<img class='screenshot img-thumbnail' src='" + data.screenshot2 + "' />");
					}

					count = 0;

					if ( data.load && data.load.resources ) {

						data.load.resources.forEach(function(resource){

							if ( resource.startReply && resource.startReply.bodySize ) {
								$(".requests").find("tbody").append(getTableRow(++count, resource.request.url, ((resource.startReply.bodySize)/1000) + "kb", resource.domLoaded));
							} else {
								$(".requests").find("tbody").append(getTableRow(++count, resource.request.url, "", resource.domLoaded));
							}
						});
					}
				});

				return false;
			});

			function getTableRow(id, testname, value, success) {

				var html = [];

				if ( success ) {
					html.push("<tr class='success'>");
				} else {
					html.push("<tr class='danger'>");
				}

				html.push("<td>");
				html.push(id);
				html.push("</td>");

				html.push("<td>");
				html.push(testname);
				html.push("</td>");

				html.push("<td>");

				if ( value != 0 ) {
					html.push(value);
				} else {
					html.push("N/A");
				}

				html.push("</td>");
				html.push("<td>");
				html.push(success);
				html.push("</td>");
				html.push("</tr>");

				return html.join("");
			}

			function getRequestRow(id, testname, value, success) {

				var html = [];

				if ( success ) {
					html.push("<tr class='danger'>");
				} else {
					html.push("<tr class='success'>");
				}

				html.push("<td>");
				html.push(id);
				html.push("</td>");

				html.push("<td>");
				html.push(testname);
				html.push("</td>");

				html.push("<td>");

				if ( value != 0 ) {
					html.push(value);
				} else {
					html.push("N/A");
				}

				html.push("</td>");

				html.push("<td>");
				html.push(success);
				html.push("</td>");

				html.push("</tr>");

				return html.join("");
			}

			function showFormError(message) {
				var elem = alertTemplate.clone();
				elem.find('span').text(message);
				$(".alertwrap").append(elem);
			}

			window.alertTemplate = $(".alert").remove().removeClass("hidden");

			if ( localStorage["lastURL"] ) {
				$("#cardurl").val(localStorage["lastURL"]);
			}
		</script>
	</body>
</html>
