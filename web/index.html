<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<meta name="description" content="">
	<meta name="author" content="">
	<link rel="shortcut icon" href="../../assets/ico/favicon.png">
	<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400,600">

	<title>Card Testing Service</title>

	<link href="css/bootstrap.css" rel="stylesheet">
	<link href="css/tester.css" rel="stylesheet">

	<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!--[if lt IE 9]>
	  <script src="../../assets/js/html5shiv.js"></script>
	  <script src="../../assets/js/respond.min.js"></script>
	  <![endif]-->

	</head>

	<body>
		<div class="navbar navbar-inverse navbar-fixed-top">
			<div class="container">
				<div class="navbar-header">
					<a class="navbar-brand" href="/"><span class="glyphicon glyphicon-cloud"></span> Card Testing Service</a>
				</div>
			</div>
		</div>

		<div class="container well">
			<div class="row">
				<div class="col-md-4">
					<h1>Card Testing Service</h1>
					<p>This service helps automates some of the simple checks that must be performed before a card can be considered for the More Card.</p>
				</div>
				<div class="col-md-8">
					<br/><br/>
					<form role="form">
						<div class="form-group m1n">
							<label for="cardurl">Card URL</label>
							<input type="text" class="form-control" id="cardurl" placeholder="Enter Card URL">
						</div>
						<div class="alertwrap">
							<div class="alert alert-danger hidden">
								<span></span>
							</div>
						</div>
						<div class="">
							<button id="submitbtn" type="submit" class="btn btn-success btn-lg">Run Tests</button>
						</div>
					</form>
					<br/>
				</div>
			</div>
		</div>

		<div class="container testresults hidden">
			<div class="row">
				<div class="col-md-12">
					<h3>Basic Tests</h3>
					<table class="table table-bordered moretests">
						<thead>
							<tr>
								<th>Test #</th>
								<th>Test</th>
								<th>Result</th>
								<th>Success</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<h3>Load &amp; Speed Tests</h3>
					<table class="table table-bordered loadtests">
						<thead>
							<tr>
								<th>Test #</th>
								<th>Test</th>
								<th>Result</th>
								<th>Success</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
			</div>
			<div class="row">
				<div class="col-md-12">
					<h3>Requests</h3>
					<table class="table table-bordered requests">
						<thead>
							<tr>
								<th>Request #</th>
								<th>URL</th>
								<th>Size</th>
								<th>DOMLoaded</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<h4 class="screenshotcontainer">Right after DOM Load</h4>
					<div class="screenshotcontainer screenshotcontainer1"></div>
				</div>
				<div class="col-md-6">
					<h4 class="screenshotcontainer">2 seconds after DOM Load</h4>
					<div class="screenshotcontainer screenshotcontainer2"></div>
				</div>
			</div>
		</div>

		<div class="container">
			<div class="row">
				<div class="col-md-12">
					<div class="tempp"></div>
				</div>
			</div>
		</div>

		<script src="//code.jquery.com/jquery.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="/zerver/API.js"></script>
		<script type="text/javascript">
			$("form").submit(function(d){

				var data = $("#cardurl").val();
				
				$(".alert").remove();

				if ( data.indexOf("http") != 0 ) {

					showFormError("URL must start with http or https");
					return false;
				}

				localStorage["lastURL"] = data;

				$("#submitbtn").addClass("disabled").text("Testing...");

				API.testCard(data, function(data){

					$("#submitbtn").removeClass("disabled").text("Run Tests");
					
					if ( !data ) {
						showFormError("Something went wrong :( Please try again.");
						return;
					}

					$(".testresults").removeClass("hidden");
					$(".moretests, .loadtests, .requests").find("tbody").html("");
					$(".screenshot").remove();

					var count = 0;

					if ( data.more && data.more.title ) {
						if ( data.more.tagLocations['kik-more'] === false ) {
							getTableRow(".moretests", ++count, "Sidebar Title", data.more.title + "<br><br> (Not in document HEAD)", -1);
						} else {
							getTableRow(".moretests", ++count, "Sidebar Title", data.more.title, true);
						}
					} else {
						getTableRow(".moretests", ++count, "Sidebar Title", "", false);
					}

					if ( data.more && data.more.icon ) {
						if ( data.more.tagLocations['kik-icon'] === false ) {
							getTableRow(".moretests", ++count, "Sidebar Icon", "<img style='width: 80px; height: 50px' src='" + data.more.icon + "' />" + "<br><br> (Not in document HEAD)", -1);
						} else {
							getTableRow(".moretests", ++count, "Sidebar Icon", "<img style='width: 80px; height: 50px' src='" + data.more.icon + "' />", true);
						}
					} else {
						getTableRow(".moretests", ++count, "Sidebar Icon", "N/A", false);
					}

					if ( data.more && data.more.description ) {
						if ( data.more.tagLocations['description'] === false ) {
							getTableRow(".moretests", ++count, "More Description", data.more.description + "<br><br> (Not in document HEAD)", -1);
						} else {
							getTableRow(".moretests", ++count, "More Description", data.more.description, true);
						}
					} else {
						getTableRow(".moretests", ++count, "More Description", "No description found", false);
					}

					if ( data.more && data.more.hostname ) {

						var canonMatchesKikMore = (data.more.hostname === data.more.canon.canon);

						if ( canonMatchesKikMore ) {
							if ( data.more.tagLocations['kik-more'] === false ) {
								getTableRow(".moretests", ++count, "Include In More", data.more.hostname + " <b>matches canonicalized URL</b>" + "<br><br> (Not in document HEAD)", -1);
							} else {
								getTableRow(".moretests", ++count, "Include In More", data.more.hostname + " <b>matches canonicalized URL</b>", canonMatchesKikMore);
							}
						} else {

							canonMatchesKikMore = (data.more.hostname === "https://" + data.more.canon.canon);
							
							if ( canonMatchesKikMore ) {
								getTableRow(".moretests", ++count, "Include In More", data.more.hostname + " <b>matches canonicalized URL</b>", canonMatchesKikMore);
							} else {
								getTableRow(".moretests", ++count, "Include In More", data.more.hostname + " <b>Should include https:// to ensure https url gets used</b>", canonMatchesKikMore);
							}
						}
					} else {
						getTableRow(".moretests", ++count, "Include In More", "No kik-more tag found", false);
					}

					if ( data.unsupported ) {
						if ( data.more.tagLocations['kik-unsupported'] === false ) {
							getTableRow(".moretests", ++count, "Unsupported OS", data.unsupported + "<br><br> (Not in document HEAD)", -1);
						} else {
							getTableRow(".moretests", ++count, "Unsupported OS", data.unsupported, true);
						}
					} else {
						getTableRow(".moretests", ++count, "Unsupported OS", "N/A", true);
					}

					if ( data.link && data.link.terms ) {

						if ( data.link.termsStatus !== 200 ) {
							getTableRow(".moretests", ++count, "T&C provided but couldn't be loaded.", "<a href='" + data.link.terms + "'>" + data.link.terms + "</a>", false);
						} else {
							if ( data.more.tagLocations['terms'] === false ) {
								getTableRow(".moretests", ++count, "T&C Provided", "<a href='" + data.link.terms + "'>" + data.link.terms + "</a>" + "<br><br> (Not in document HEAD)", -1);
							} else {
								getTableRow(".moretests", ++count, "T&C Provided", "<a href='" + data.link.terms + "'>" + data.link.terms + "</a>", true);
							}
						}
					} else {
						getTableRow(".moretests", ++count, "T&C Provided", "Not Provided", true);
					}

					if ( data.link && data.link.privacy ) {

						if ( data.link.privacyStatus !== 200 ) {
							getTableRow(".moretests", ++count, "Privacy Policy provided but couldn't be loaded.", "<a href='" + data.link.privacy + "'>" + data.link.privacy + "</a>", false);
						} else {
							if ( data.more.tagLocations['privacy'] === false ) {
								getTableRow(".moretests", ++count, "Privacy Policy Provided", "<a href='" + data.link.privacy + "'>" + data.link.privacy + "</a>" + "<br><br> (Not in document HEAD)", -1);
							} else {
								getTableRow(".moretests", ++count, "Privacy Policy Provided", "<a href='" + data.link.privacy + "'>" + data.link.privacy + "</a>", true);
							}
						}
					} else {
						getTableRow(".moretests", ++count, "Privacy Policy Provided", "Not Provided", true);
					}

					if ( data.layout && (data.layout.topbar_android == 48) ) {
						getTableRow(".moretests", ++count, "Topbar Height - Android", "Topbar is " + data.layout.topbar_android + "px", true);
					} else {
						getTableRow(".moretests", ++count, "Topbar Height - Android", "Couldn't get height", -1);
					}

					if ( data.layout && (data.layout.topbar_ios == 44) ) {
						getTableRow(".moretests", ++count, "Topbar Height - iOS", "Topbar is " + data.layout.topbar_ios + "px", true);
					} else {
						getTableRow(".moretests", ++count, "Topbar Height - iOS", "Couldn't get height", -1);
					}

					count = 0;

					if ( data.load ) {
						getTableRow(".loadtests", ++count, "Cache Manifest", data.load.manifest ? data.load.manifest : "No manifest found", data.load.manifest ? true : false);
					}

					if ( data.load ) {

						var requestCount = 0;

						data.load.resources.forEach(function(resource){

							if ( resource.request.url.indexOf("card://") >= 0 || resource.request.url.indexOf("cards://") >= 0 || resource.request.url.indexOf(data.load.manifest) >= 0 ) {
								return;
							}

							if ( resource.domLoaded === false ) {
								requestCount++;
							}
						});

						var blocksLoad = (requestCount > 0 ? false : true);

						getTableRow(".loadtests", ++count, "Blocks DOM Load", requestCount > 0 ? requestCount + " extra requests" : "Not blocking DOM Load", blocksLoad);
					}

					if ( data.load && data.load.domLoad ) {
						getTableRow(".loadtests", ++count, "DOMContentLoaded", data.load.domLoad + " ms", (data.load.domLoad < 1250 ? true : false));
					}

					if ( data.load && data.load.fullLoad ) {
						getTableRow(".loadtests", ++count, "Full Load Time", data.load.fullLoad + " ms", (data.load.fullLoad < 1250 ? true : false));
					}

					if ( data.load && data.load.requestCount ) {
						getTableRow(".loadtests", ++count, "# of Requests", data.load.requestCount, (data.load.requestCount < 50 ? true : false));
					}

					if ( data.load ) {
						getTableRow(".loadtests", ++count, "Card Size - Before DOMLoad", (data.load.cardSize/1000) + " kb", (data.load.cardSize < 350000 ? true : false));
					}

					if ( data.load ) {
						getTableRow(".loadtests", ++count, "Card Size - All Requests", (data.load.fullSize/1000) + " kb", (data.load.fullSize < 500000 ? true : false));
					}

					if ( data.screenshot ) {
						$(".screenshotcontainer1").append("<img class='screenshot img-thumbnail' src='" + data.screenshot + "' />");
						$(".screenshotcontainer2").append("<img class='screenshot img-thumbnail' src='" + data.screenshot2 + "' />");
					}

					count = 0;

					if ( data.load && data.load.resources ) {

						data.load.resources.forEach(function(resource){

							if ( resource.request.url.indexOf("card://") >= 0 || resource.request.url.indexOf("cards://") >= 0 ) {
								return;
							}

							if ( resource.startReply && resource.startReply.bodySize ) {
								$(".requests").find("tbody").append(getRequestRow(++count, resource.request.url, ((resource.startReply.bodySize)/1000) + "kb", resource.domLoaded));
							} else {
								$(".requests").find("tbody").append(getRequestRow(++count, resource.request.url, "", resource.domLoaded));
							}
						});
					}
				});

				return false;
			});

			function getTableRow(elemid, id, testname, value, success) {

				var html = [];

				if ( success === true ) {
					html.push("<tr class='success'>");
				} else {
					if ( success === -1 ) {
						html.push("<tr class='warning'>");
					} else {
						html.push("<tr class='danger'>");
					}
				}

				html.push("<td>");
				html.push(id);
				html.push("</td>");

				html.push("<td>");
				html.push(testname);
				html.push("</td>");

				html.push("<td>");

				if ( value != 0 ) {
					html.push(value);
				} else {
					html.push("N/A");
				}

				html.push("</td>");
				html.push("<td>");
				if ( success === -1 ) {
					html.push("Warn");
				} else {
					html.push( success===true ? "Yes" : "No" );
				}
				html.push("</td>");
				html.push("</tr>");

				$(elemid).find("tbody").append(html.join(""));
			}

			function getRequestRow(id, testname, value, success) {

				var html = [];

				if ( testname.indexOf(".manifest") >= 0 ) {
					html.push("<tr class='active'>");
				} else {
					if ( success ) {
						html.push("<tr class='success'>");
					} else {
						html.push("<tr class='danger'>");
					}
				}

				html.push("<td>");
				html.push(id);
				html.push("</td>");

				html.push("<td>");
				html.push(testname);
				html.push("</td>");

				html.push("<td>");

				if ( value != 0 ) {
					html.push(value);
				} else {
					html.push("N/A");
				}

				html.push("</td>");

				html.push("<td>");
				html.push(success);
				html.push("</td>");

				html.push("</tr>");

				return html.join("");
			}

			function showFormError(message) {
				var elem = alertTemplate.clone();
				elem.find('span').text(message);
				$(".alertwrap").append(elem);
			}

			window.alertTemplate = $(".alert").remove().removeClass("hidden");

			if ( localStorage["lastURL"] ) {
				$("#cardurl").val(localStorage["lastURL"]);
			}
		</script>
	</body>
</html>
